{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport documentRequestService from '@/services/documentRequestService';\nimport clientAuthService from '@/services/clientAuthService';\nimport paymentService from '@/services/paymentService';\nimport addressService from '@/services/addressService';\nimport FileUpload from '@/components/common/FileUpload.vue';\nexport default {\n  name: 'CedulaRequest',\n  components: {\n    FileUpload\n  },\n  data() {\n    return {\n      currentStep: 1,\n      submitting: false,\n      purposeCategories: [],\n      paymentMethods: [],\n      // Grouped payment methods for display\n      originalPaymentMethods: [],\n      // Original payment methods from backend\n      processingFee: 5.00,\n      // Processing fee\n      basicTax: 5.00,\n      // Basic community tax\n      familyRelationshipError: null,\n      formData: {\n        document_type_id: 1,\n        // Cedula\n        purpose_category_id: '',\n        purpose_details: '',\n        is_third_party_request: false,\n        beneficiary: {\n          first_name: '',\n          middle_name: '',\n          last_name: '',\n          suffix: '',\n          birth_date: '',\n          gender: '',\n          civil_status_id: '',\n          nationality: 'Filipino',\n          phone_number: '',\n          email: '',\n          house_number: '',\n          street: '',\n          subdivision: '',\n          barangay: 'Bula',\n          city_municipality: 'General Santos City (Dadiangas)',\n          province: 'South Cotabato',\n          postal_code: '',\n          years_of_residency: null,\n          months_of_residency: null,\n          relationship_to_requestor: '',\n          region_code: '12',\n          province_code: '1263',\n          city_code: '126303',\n          barangay_code: '126303005'\n        },\n        authorized_pickup: {\n          first_name: '',\n          middle_name: '',\n          last_name: '',\n          suffix: '',\n          phone_number: '',\n          email: '',\n          relationship_to_beneficiary: ''\n        },\n        annual_income: 0,\n        income_source: '',\n        business_name: '',\n        business_address: '',\n        business_nature: '',\n        has_real_property: false,\n        property_value: 0,\n        property_location: '',\n        has_personal_property: false,\n        personal_property_value: 0,\n        has_business: false,\n        business_gross_receipts: 0,\n        business_type: '',\n        payment_method_id: '',\n        agree_to_terms: false\n      },\n      pickupOption: 'self',\n      // 'self' or 'authorized'\n      uploadedFiles: {\n        beneficiary_verification: null,\n        pickup_id_image: null,\n        pickup_authorization: null\n      },\n      civilStatuses: [],\n      clientData: null,\n      // Fresh profile data\n\n      // Address dropdown data\n      regions: [],\n      provinces: [],\n      cities: [],\n      barangays: [],\n      filteredProvinces: [],\n      filteredCities: [],\n      filteredBarangays: [],\n      // Validation control\n      isValidating: false\n    };\n  },\n  computed: {\n    // Keep the old method as fallback\n    cachedClientData() {\n      return clientAuthService.getCurrentUser();\n    },\n    shouldShowPurposeDetails() {\n      // Show purpose details only when \"Other\" category (id=10) is selected\n      return this.formData.purpose_category_id === 10;\n    },\n    familyVerificationPlaceholder() {\n      // Dynamic placeholder based on relationship selection\n      if (this.formData.beneficiary.relationship_to_requestor === 'spouse') {\n        return 'Click to upload spouse verification image';\n      }\n      return 'Click to upload family Member Verification Image';\n    },\n    familyVerificationText() {\n      // Dynamic verification text based on relationship selection\n      if (this.formData.beneficiary.relationship_to_requestor === 'spouse') {\n        return 'To verify that this person is indeed your spouse, please upload a clear photo of Marriage Application.';\n      }\n      return 'To verify that this person is indeed your family member, please upload a clear photo of their valid ID (Driver\\'s License, National ID, Passport, etc.).';\n    },\n    // Debug computed property for submit button state\n    submitButtonDisabled() {\n      const disabled = this.submitting || !this.formData.agree_to_terms;\n      console.log('üîò Submit button disabled:', disabled, {\n        submitting: this.submitting,\n        agree_to_terms: this.formData.agree_to_terms,\n        currentStep: this.currentStep\n      });\n      return disabled;\n    },\n    incomeTax() {\n      const income = this.formData.annual_income || 0;\n\n      // Official Philippine Community Tax Formula (2024)\n      // Source: Local Government Code, MoneyMax 2024 guide\n      // Additional tax: ‚Ç±1 for every ‚Ç±1,000 of gross earnings\n      const additionalTax = Math.floor(income / 1000) * 1.00;\n      return Math.min(additionalTax, 5000); // Maximum additional tax ‚Ç±5,000\n    },\n    propertyTax() {\n      let tax = 0;\n\n      // Real property tax - FIXED: Use ‚Ç±1 per ‚Ç±1,000 formula (Philippine Community Tax Law)\n      if (this.formData.has_real_property) {\n        const realValue = this.formData.property_value || 0;\n        tax += Math.floor(realValue / 1000) * 1.00;\n      }\n\n      // Personal property tax - FIXED: Use ‚Ç±1 per ‚Ç±1,000 formula (Philippine Community Tax Law)\n      if (this.formData.has_personal_property) {\n        const personalValue = this.formData.personal_property_value || 0;\n        tax += Math.floor(personalValue / 1000) * 1.00;\n      }\n      return Math.min(tax, 5000); // Maximum property tax\n    },\n    businessTax() {\n      if (!this.formData.has_business) return 0;\n      const receipts = this.formData.business_gross_receipts || 0;\n      // FIXED: Use ‚Ç±1 per ‚Ç±1,000 formula (Philippine Community Tax Law)\n      const tax = Math.floor(receipts / 1000) * 1.00;\n      return Math.min(tax, 5000); // Maximum business tax\n    },\n    totalTax() {\n      // Official Philippine Community Tax Formula (2024)\n      const basicTax = 5.00; // Basic community tax minimum ‚Ç±5\n      const additionalTax = this.incomeTax + this.propertyTax + this.businessTax;\n      return basicTax + additionalTax;\n    },\n    convenienceFee() {\n      // PayMongo minimum payment requirement: ‚Ç±100.00 (confirmed by API testing)\n      const baseTotal = this.totalTax + this.processingFee;\n      const paymongoMinimum = 100.00;\n      return Math.max(0, paymongoMinimum - baseTotal);\n    },\n    totalFee() {\n      return this.totalTax + this.processingFee + this.convenienceFee;\n    }\n  },\n  async mounted() {\n    console.log('üéØ CedulaRequest component mounted');\n\n    // Migrate legacy auth if needed\n    clientAuthService.migrateLegacyAuth();\n\n    // Check authentication status (unified auth system)\n    const token = localStorage.getItem('auth_token') || localStorage.getItem('clientToken');\n    const clientData = localStorage.getItem('auth_user') || localStorage.getItem('clientData');\n    console.log('üîë Auth token exists:', !!token);\n    console.log('üë§ Client data exists:', !!clientData);\n    if (clientData) {\n      try {\n        const parsedData = JSON.parse(clientData);\n        console.log('üë§ Client data:', parsedData);\n      } catch (e) {\n        console.error('‚ùå Error parsing client data:', e);\n      }\n    }\n    await this.loadFormData();\n  },\n  methods: {\n    async loadFormData() {\n      try {\n        // Load fresh profile data first\n        console.log('Loading fresh profile data...');\n        const profileResponse = await clientAuthService.getProfile();\n        if (profileResponse.success) {\n          this.clientData = profileResponse.data;\n          console.log('Fresh profile data loaded:', this.clientData);\n        } else {\n          // Fallback to cached data\n          this.clientData = this.cachedClientData;\n          console.log('Using cached profile data:', this.clientData);\n        }\n        const [purposeResponse, paymentResponse] = await Promise.all([documentRequestService.getPurposeCategories(), documentRequestService.getPaymentMethods(), this.loadCivilStatuses(), this.loadAddressData()]);\n        this.purposeCategories = purposeResponse.data || [];\n        this.originalPaymentMethods = paymentResponse.data || [];\n        this.paymentMethods = paymentService.groupPaymentMethods(this.originalPaymentMethods);\n      } catch (error) {\n        console.error('Error loading form data:', error);\n        // Fallback to cached data on error\n        this.clientData = this.cachedClientData;\n        this.showToast('Error', 'Failed to load some form data', 'error');\n      }\n    },\n    onPurposeChange() {\n      // Clear purpose details if not \"Other\" category (id=10)\n      if (!this.shouldShowPurposeDetails) {\n        this.formData.purpose_details = '';\n      }\n    },\n    sanitizeRequestData(data) {\n      // Convert undefined values to null to prevent MySQL binding errors\n      const sanitized = {};\n      for (const [key, value] of Object.entries(data)) {\n        if (value === undefined) {\n          sanitized[key] = null;\n        } else if (value === '') {\n          sanitized[key] = null;\n        } else if (typeof value === 'object' && value !== null) {\n          // Recursively sanitize nested objects\n          sanitized[key] = this.sanitizeRequestData(value);\n        } else {\n          sanitized[key] = value;\n        }\n      }\n      return sanitized;\n    },\n    getFullName() {\n      // Try fresh data first, then fallback to cached data structure\n      const profile = this.clientData || this.clientData?.profile;\n      if (!profile) return 'N/A';\n      return `${profile.first_name || ''} ${profile.middle_name || ''} ${profile.last_name || ''}`.trim();\n    },\n    getFullAddress() {\n      // Try fresh data first, then fallback to cached data structure\n      const profile = this.clientData || this.clientData?.profile;\n      if (!profile) return 'Not provided';\n      const parts = [profile.house_number, profile.street, profile.subdivision, profile.barangay, profile.city_municipality || profile.city, profile.province].filter(Boolean);\n      return parts.length > 0 ? parts.join(', ') : 'Not provided';\n    },\n    formatGender(gender) {\n      if (!gender) return 'Not provided';\n      return gender.charAt(0).toUpperCase() + gender.slice(1);\n    },\n    getCivilStatusName(statusId) {\n      const statuses = {\n        1: 'Single',\n        2: 'Married',\n        3: 'Divorced',\n        4: 'Widowed',\n        5: 'Separated'\n      };\n      return statuses[statusId] || 'Not provided';\n    },\n    getResidencyDisplay() {\n      // Try fresh data first, then fallback to cached data structure\n      const profile = this.clientData || this.clientData?.profile;\n      if (!profile) return 'Not provided';\n      const years = profile.years_of_residency;\n      const months = profile.months_of_residency;\n      if (!years && !months) return 'Not provided';\n      const parts = [];\n      if (years) parts.push(`${years} year${years > 1 ? 's' : ''}`);\n      if (months) parts.push(`${months} month${months > 1 ? 's' : ''}`);\n      return parts.join(' and ');\n    },\n    formatDate(dateString) {\n      if (!dateString) return 'Not provided';\n      return new Date(dateString).toLocaleDateString();\n    },\n    formatCurrency(amount) {\n      return parseFloat(amount || 0).toFixed(2);\n    },\n    // REMOVED: Incorrect percentage-based rate methods\n    // Philippine Community Tax Law uses ‚Ç±1 per ‚Ç±1,000 formula for all categories\n    // These methods were causing the calculation bug\n\n    calculateTax() {\n      // Tax calculation is handled by computed properties\n      this.$forceUpdate();\n    },\n    canProceedToNextStep() {\n      const result = (() => {\n        switch (this.currentStep) {\n          case 1:\n            {\n              let basicValidation = this.formData.purpose_category_id;\n\n              // Only require purpose details if the field is shown (Other category, id=10)\n              if (this.shouldShowPurposeDetails) {\n                basicValidation = basicValidation && this.formData.purpose_details && this.formData.purpose_details.length >= 10;\n              }\n              if (!basicValidation) return false;\n\n              // Additional validation for third-party requests\n              if (this.formData.is_third_party_request) {\n                return this.validateBeneficiaryData();\n              }\n              return true;\n            }\n          case 2:\n            return this.formData.annual_income >= 0 && this.formData.income_source && this.formData.has_real_property !== null && this.formData.has_personal_property !== null && this.formData.has_business !== null;\n          case 3:\n            {\n              const paymentValid = this.formData.payment_method_id;\n              if (!paymentValid) return false;\n\n              // Additional validation for authorized pickup\n              if (this.pickupOption === 'authorized') {\n                return this.validateAuthorizedPickup();\n              }\n              return true;\n            }\n          default:\n            return true;\n        }\n      })();\n      console.log(`üîç canProceedToNextStep (step ${this.currentStep}):`, result);\n      if (this.currentStep === 1) {\n        console.log('  - purpose_category_id:', this.formData.purpose_category_id);\n        console.log('  - purpose_details:', this.formData.purpose_details);\n      } else if (this.currentStep === 2) {\n        console.log('  - annual_income:', this.formData.annual_income);\n        console.log('  - income_source:', this.formData.income_source);\n        console.log('  - has_real_property:', this.formData.has_real_property);\n        console.log('  - has_personal_property:', this.formData.has_personal_property);\n        console.log('  - has_business:', this.formData.has_business);\n      } else if (this.currentStep === 3) {\n        console.log('  - payment_method_id:', this.formData.payment_method_id);\n      }\n      return result;\n    },\n    nextStep() {\n      console.log('üîÑ nextStep called, current step:', this.currentStep);\n      const canProceed = this.canProceedToNextStep();\n      console.log('üîç Can proceed:', canProceed);\n      if (canProceed && this.currentStep < 4) {\n        this.currentStep++;\n        console.log('‚úÖ Moved to step:', this.currentStep);\n      } else {\n        console.log('‚ùå Cannot proceed to next step');\n      }\n    },\n    previousStep() {\n      if (this.currentStep > 1) {\n        this.currentStep--;\n      }\n    },\n    selectPaymentMethod(methodId) {\n      this.formData.payment_method_id = methodId;\n    },\n    getActualPaymentMethodId() {\n      return paymentService.getActualPaymentMethodId(this.formData.payment_method_id, this.originalPaymentMethods);\n    },\n    getPaymentIcon(methodCode) {\n      const icons = {\n        'CASH': 'fas fa-money-bill',\n        'ONLINE_PAYMENT_GROUP': 'fas fa-credit-card',\n        'PAYMONGO_CARD': 'fas fa-credit-card',\n        'PAYMONGO_GCASH': 'fab fa-google-pay',\n        'PAYMONGO_GRABPAY': 'fas fa-mobile-alt',\n        'PAYMONGO_PAYMAYA': 'fas fa-wallet',\n        'PAYMONGO_BANK': 'fas fa-university'\n      };\n      return icons[methodCode] || 'fas fa-credit-card';\n    },\n    getPurposeCategoryName() {\n      const category = this.purposeCategories.find(c => c.id === this.formData.purpose_category_id);\n      return category?.category_name || '';\n    },\n    getPaymentMethodName() {\n      const method = this.paymentMethods.find(m => m.id === this.formData.payment_method_id);\n      return method?.method_name || '';\n    },\n    getPaymentMethodDisplayName(methodCode) {\n      return paymentService.getPaymentMethodDisplayName(methodCode);\n    },\n    // Handle phone number input to restrict to digits only\n    handlePhoneInput(event, section) {\n      const value = event.target.value;\n      // Remove any non-digit characters\n      const digitsOnly = value.replace(/\\D/g, '');\n      // Limit to 11 digits\n      const limitedValue = digitsOnly.substring(0, 11);\n      if (section === 'beneficiary') {\n        this.formData.beneficiary.phone_number = limitedValue;\n      } else if (section === 'authorized_pickup') {\n        this.formData.authorized_pickup.phone_number = limitedValue;\n      }\n    },\n    // New methods for third-party requests\n    handleRequestTypeChange() {\n      if (!this.formData.is_third_party_request) {\n        // Reset beneficiary data when switching back to self\n        this.resetBeneficiaryData();\n        this.familyRelationshipError = null;\n      }\n    },\n    handleGenderChange() {\n      // Clear suffix when male is not selected since suffix field will be hidden\n      if (this.formData.beneficiary.gender !== 'male') {\n        this.formData.beneficiary.suffix = '';\n      }\n    },\n    validateFamilyRelationship() {\n      this.familyRelationshipError = null;\n      if (!this.formData.is_third_party_request) {\n        return true;\n      }\n      const relationship = this.formData.beneficiary.relationship_to_requestor;\n      if (!relationship) {\n        return true; // Will be caught by required validation\n      }\n\n      // Define allowed immediate family relationships\n      const allowedRelationships = ['spouse', 'husband', 'wife', 'child', 'son', 'daughter', 'parent', 'father', 'mother', 'sibling', 'brother', 'sister'];\n      if (!allowedRelationships.includes(relationship.toLowerCase())) {\n        this.familyRelationshipError = 'You can only request documents on behalf of immediate family members (spouse, children, parents, siblings).';\n        return false;\n      }\n      return true;\n    },\n    handlePickupOptionChange() {\n      if (this.pickupOption !== 'authorized') {\n        // Reset authorized pickup data\n        this.resetAuthorizedPickupData();\n      }\n    },\n    resetBeneficiaryData() {\n      this.formData.beneficiary = {\n        first_name: '',\n        middle_name: '',\n        last_name: '',\n        suffix: '',\n        birth_date: '',\n        gender: '',\n        civil_status_id: '',\n        nationality: 'Filipino',\n        phone_number: '',\n        email: '',\n        house_number: '',\n        street: '',\n        subdivision: '',\n        barangay: 'Bula',\n        city_municipality: 'General Santos City (Dadiangas)',\n        province: 'South Cotabato',\n        postal_code: '',\n        years_of_residency: null,\n        months_of_residency: null,\n        relationship_to_requestor: '',\n        region: 'Region XII (SOCCSKSARGEN)',\n        region_code: '12',\n        province_code: '1263',\n        city_code: '126303',\n        barangay_code: '126303005'\n      };\n    },\n    resetAuthorizedPickupData() {\n      this.formData.authorized_pickup = {\n        first_name: '',\n        middle_name: '',\n        last_name: '',\n        suffix: '',\n        phone_number: '',\n        email: '',\n        relationship_to_beneficiary: ''\n      };\n      // Also reset the uploaded files\n      this.uploadedFiles.pickup_id_image = null;\n      this.uploadedFiles.pickup_authorization = null;\n    },\n    async loadCivilStatuses() {\n      try {\n        // For now, use a static list. In production, this would be an API call\n        this.civilStatuses = [{\n          id: 1,\n          status_name: 'Single'\n        }, {\n          id: 2,\n          status_name: 'Married'\n        }, {\n          id: 3,\n          status_name: 'Widowed'\n        }, {\n          id: 4,\n          status_name: 'Divorced'\n        }, {\n          id: 5,\n          status_name: 'Separated'\n        }];\n      } catch (error) {\n        console.error('Error loading civil statuses:', error);\n      }\n    },\n    validateBeneficiaryData() {\n      if (!this.formData.is_third_party_request) return true;\n      const required = ['first_name', 'last_name', 'birth_date', 'gender', 'civil_status_id', 'region_code', 'province_code', 'city_code', 'barangay_code', 'relationship_to_requestor'];\n      for (const field of required) {\n        if (!this.formData.beneficiary[field]) {\n          this.showToast('Error', `Please fill in the beneficiary's ${field.replace('_', ' ')}`, 'error');\n          return false;\n        }\n      }\n\n      // Validate family relationship\n      if (!this.validateFamilyRelationship()) {\n        this.showToast('Error', this.familyRelationshipError, 'error');\n        return false;\n      }\n\n      // Check for required verification image\n      if (!this.uploadedFiles.beneficiary_verification) {\n        this.showToast('Error', 'Please upload the family member\\'s verification ID image', 'error');\n        return false;\n      }\n      return true;\n    },\n    validateAuthorizedPickup(showErrors = false) {\n      console.log('üîç validateAuthorizedPickup called with showErrors:', showErrors);\n      console.log('üîç pickupOption:', this.pickupOption);\n      console.log('üîç authorized_pickup data:', this.formData.authorized_pickup);\n      if (this.pickupOption !== 'authorized') {\n        console.log('‚úÖ Not authorized pickup, validation passed');\n        return true;\n      }\n\n      // Prevent multiple validation calls in quick succession\n      if (this.isValidating) {\n        console.log('‚ö†Ô∏è Validation already in progress, skipping');\n        return false;\n      }\n      if (showErrors) {\n        this.isValidating = true;\n        setTimeout(() => {\n          this.isValidating = false;\n        }, 1000); // Reset after 1 second\n      }\n      const required = ['first_name', 'last_name', 'phone_number', 'relationship_to_beneficiary'];\n      for (const field of required) {\n        const value = this.formData.authorized_pickup[field];\n        console.log(`üîç Checking field ${field}:`, value);\n        if (!value || value.trim() === '') {\n          if (showErrors) {\n            console.log(`‚ùå Field ${field} is missing`);\n            this.showToast('Error', `Please fill in the pickup person's ${field.replace('_', ' ')}`, 'error');\n          }\n          return false;\n        }\n      }\n\n      // Check for required file uploads\n      if (!this.uploadedFiles.pickup_id_image) {\n        if (showErrors) {\n          console.log('‚ùå Missing pickup ID image');\n          this.showToast('Error', 'Please upload the pickup person\\'s valid ID image', 'error');\n        }\n        return false;\n      }\n      if (!this.uploadedFiles.pickup_authorization) {\n        if (showErrors) {\n          console.log('‚ùå Missing pickup authorization');\n          this.showToast('Error', 'Please upload the authorization letter', 'error');\n        }\n        return false;\n      }\n      console.log('‚úÖ Authorized pickup validation passed');\n      return true;\n    },\n    handleSubmitClick(event) {\n      console.log('üî• Submit button clicked!', event);\n      console.log('üìã Form data:', this.formData);\n      console.log('‚úÖ Agree to terms:', this.formData.agree_to_terms);\n      console.log('üîÑ Current step:', this.currentStep);\n      console.log('üö´ Button disabled:', this.submitting || !this.formData.agree_to_terms);\n\n      // Don't prevent default here, let the form submission happen naturally\n    },\n    async handleSubmit() {\n      console.log('üöÄ handleSubmit called');\n      console.log('üìã Form data:', this.formData);\n      console.log('‚úÖ Agree to terms:', this.formData.agree_to_terms);\n      if (!this.formData.agree_to_terms) {\n        console.log('‚ùå Terms not agreed to');\n        this.showToast('Error', 'Please agree to the terms and conditions', 'error');\n        return;\n      }\n\n      // Debug pickup option and form data\n      console.log('üîç DEBUG: pickupOption =', this.pickupOption);\n      console.log('üîç DEBUG: authorized_pickup data =', JSON.stringify(this.formData.authorized_pickup, null, 2));\n      console.log('üîç DEBUG: uploadedFiles =', this.uploadedFiles);\n\n      // Final validation with error messages for authorized pickup\n      if (this.pickupOption === 'authorized') {\n        console.log('üîç Running final validation for authorized pickup...');\n        if (!this.validateAuthorizedPickup(true)) {\n          console.log('‚ùå Validation failed, stopping submission');\n          this.submitting = false;\n          return;\n        }\n        console.log('‚úÖ Validation passed, continuing with submission');\n      }\n      try {\n        console.log('üîÑ Starting submission process...');\n        this.submitting = true;\n\n        // Check authentication (unified auth system)\n        const token = localStorage.getItem('auth_token') || localStorage.getItem('clientToken');\n        console.log('üîë Auth token exists:', !!token);\n        if (!token) {\n          this.showToast('Error', 'Please log in to submit a request', 'error');\n          this.submitting = false;\n          return;\n        }\n\n        // Ensure required fields are properly formatted and sanitize undefined values\n        const requestData = this.sanitizeRequestData({\n          // Core document request fields\n          document_type_id: parseInt(this.formData.document_type_id),\n          purpose_category_id: parseInt(this.formData.purpose_category_id),\n          purpose_details: this.shouldShowPurposeDetails && this.formData.purpose_details && this.formData.purpose_details.length >= 10 ? this.formData.purpose_details : null,\n          payment_method_id: this.getActualPaymentMethodId(),\n          delivery_method: 'pickup',\n          priority: 'normal',\n          // Third-party request data\n          is_third_party_request: this.formData.is_third_party_request || false,\n          requestor_notes: null,\n          beneficiary: this.formData.is_third_party_request ? this.formData.beneficiary : null,\n          authorized_pickup: this.pickupOption === 'authorized' ? this.formData.authorized_pickup : null,\n          // Cedula-specific fields - ensure numeric fields are numbers\n          annual_income: parseFloat(this.formData.annual_income) || 0,\n          monthly_income: parseFloat(this.formData.monthly_income) || 0,\n          property_assessed_value: parseFloat(this.formData.property_value) || 0,\n          business_income: parseFloat(this.formData.business_gross_receipts) || 0,\n          business_gross_receipts: parseFloat(this.formData.business_gross_receipts) || 0,\n          // Optional text fields\n          occupation: this.formData.occupation || null,\n          employer_name: this.formData.employer_name || null,\n          employer_address: this.formData.employer_address || null,\n          business_name: this.formData.business_name || null,\n          business_address: this.formData.business_address || null,\n          business_type: this.formData.business_type || null,\n          property_location: this.formData.property_location || null,\n          tin_number: this.formData.tin_number || null,\n          previous_ctc_number: this.formData.previous_ctc_number || null,\n          previous_ctc_date_issued: this.formData.previous_ctc_date_issued || null,\n          previous_ctc_place_issued: this.formData.previous_ctc_place_issued || null,\n          // Boolean fields\n          has_real_property: Boolean(this.formData.has_real_property),\n          has_personal_property: Boolean(this.formData.has_personal_property),\n          // Numeric fields with defaults\n          personal_property_value: parseFloat(this.formData.personal_property_value) || 0,\n          // Computed values\n          computed_tax: this.totalTax || 0,\n          total_fee: this.totalFee || 0,\n          // CRITICAL: Send exact total_document_fee for PayMongo accuracy\n          total_document_fee: this.totalFee || 0\n        });\n        console.log('üì§ Request data to submit:', requestData);\n\n        // Validate required fields\n        if (!requestData.purpose_category_id) {\n          this.showToast('Error', 'Please select a purpose category', 'error');\n          this.submitting = false;\n          return;\n        }\n\n        // Only validate purpose details if the field is shown (Other category, id=10)\n        if (this.shouldShowPurposeDetails && (!requestData.purpose_details || requestData.purpose_details.length < 10)) {\n          this.showToast('Error', 'Purpose details must be at least 10 characters long', 'error');\n          this.submitting = false;\n          return;\n        }\n        if (!requestData.payment_method_id) {\n          this.showToast('Error', 'Please select a payment method', 'error');\n          this.submitting = false;\n          return;\n        }\n        console.log('üì° Making API call...');\n        const response = await documentRequestService.submitRequest(requestData);\n        console.log('‚úÖ API response:', response);\n\n        // Upload beneficiary verification if this is a third-party request\n        if (this.formData.is_third_party_request && this.uploadedFiles.beneficiary_verification && response.data.id) {\n          console.log('üì§ Uploading beneficiary verification...');\n          await this.uploadBeneficiaryVerification(response.data.id);\n        }\n\n        // Upload files if this is an authorized pickup request\n        if (this.pickupOption === 'authorized' && response.data.id) {\n          console.log('üì§ Uploading pickup authorization files...');\n          await this.uploadPickupFiles(response.data.id);\n        }\n        this.showToast('Success', 'Cedula request submitted successfully!', 'success');\n        this.$router.push({\n          name: 'RequestDetails',\n          params: {\n            id: response.data.id\n          }\n        });\n      } catch (error) {\n        console.error('‚ùå Error submitting request:', error);\n        console.error('‚ùå Error response:', error.response);\n        console.error('‚ùå Error data:', error.response?.data);\n        let errorMessage = 'Failed to submit request';\n        if (error.response?.data?.message) {\n          errorMessage = error.response.data.message;\n        } else if (error.response?.data?.error) {\n          errorMessage = error.response.data.error;\n        } else if (error.message) {\n          errorMessage = error.message;\n        }\n        this.showToast('Error', errorMessage, 'error');\n      } finally {\n        console.log('üèÅ Submission process completed');\n        this.submitting = false;\n      }\n    },\n    async uploadBeneficiaryVerification(requestId) {\n      try {\n        console.log('üîç Starting beneficiary verification upload for request:', requestId);\n\n        // First, get the beneficiary ID from the request\n        const api = (await import('@/services/api.js')).default;\n        const requestResponse = await api.get(`/client/document-requests/${requestId}`);\n        if (!requestResponse.data.success || !requestResponse.data.data.beneficiary) {\n          throw new Error('Beneficiary information not found');\n        }\n        const beneficiaryId = requestResponse.data.data.beneficiary.id;\n        console.log('üìã Found beneficiary ID:', beneficiaryId);\n\n        // Upload the verification image\n        const formData = new FormData();\n        formData.append('verification_image', this.uploadedFiles.beneficiary_verification);\n        const uploadResponse = await api.post(`/verification-documents/beneficiary/${beneficiaryId}/verification-image`, formData, {\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          }\n        });\n        if (uploadResponse.data.success) {\n          console.log('‚úÖ Beneficiary verification uploaded successfully');\n          this.showToast('Success', 'Family member verification uploaded successfully', 'success');\n        } else {\n          throw new Error(uploadResponse.data.message || 'Upload failed');\n        }\n      } catch (error) {\n        console.error('‚ùå Error uploading beneficiary verification:', error);\n        console.error('‚ùå Error response:', error.response?.data);\n        // Don't throw the error - the request was already created successfully\n        this.showToast('Warning', 'Request created but verification image failed to upload. You can upload it later.', 'warning');\n      }\n    },\n    async uploadPickupFiles(requestId) {\n      try {\n        console.log('üîç Starting file upload for request:', requestId);\n\n        // Import the API service\n        const api = (await import('@/services/api.js')).default;\n\n        // First, get the authorized pickup person ID from the backend\n        const pickupResponse = await api.get(`/client/document-requests/${requestId}/authorization-status`);\n        const pickupPersonId = pickupResponse.data.data?.pickup_person?.id;\n        if (!pickupPersonId) {\n          console.error('‚ùå No pickup person ID found');\n          console.error('‚ùå Response data:', pickupResponse.data);\n          return;\n        }\n        console.log('‚úÖ Found pickup person ID:', pickupPersonId);\n\n        // Upload ID image if available\n        if (this.uploadedFiles.pickup_id_image) {\n          console.log('üì§ Uploading pickup ID image...');\n          const idFormData = new FormData();\n          idFormData.append('id_image', this.uploadedFiles.pickup_id_image);\n          const idResponse = await api.post(`/verification-documents/pickup-person/${pickupPersonId}/id-image`, idFormData, {\n            headers: {\n              'Content-Type': 'multipart/form-data'\n            }\n          });\n          console.log('‚úÖ ID image uploaded successfully:', idResponse.data);\n        }\n\n        // Upload authorization document if available\n        if (this.uploadedFiles.pickup_authorization) {\n          console.log('üì§ Uploading authorization document...');\n          const authFormData = new FormData();\n          authFormData.append('authorization_document', this.uploadedFiles.pickup_authorization);\n          const authResponse = await api.post(`/verification-documents/pickup-person/${pickupPersonId}/authorization-document`, authFormData, {\n            headers: {\n              'Content-Type': 'multipart/form-data'\n            }\n          });\n          console.log('‚úÖ Authorization document uploaded successfully:', authResponse.data);\n        }\n        console.log('üéâ All pickup files uploaded successfully');\n      } catch (error) {\n        console.error('‚ùå Error uploading pickup files:', error);\n        console.error('‚ùå Error response:', error.response?.data);\n        // Don't throw the error - the request was already created successfully\n        this.showToast('Warning', 'Request created but some files failed to upload. You can upload them later.', 'warning');\n      }\n    },\n    goBack() {\n      this.$router.push({\n        name: 'NewDocumentRequest'\n      });\n    },\n    updateProfile() {\n      // TODO: Navigate to profile update page\n      console.log('Update profile');\n    },\n    showTerms() {\n      // TODO: Show terms and conditions modal\n      console.log('Show terms');\n    },\n    showToast(title, message, type = 'info') {\n      // Log to console for debugging\n      console.log(`[${type.toUpperCase()}] ${title}: ${message}`);\n\n      // Create a simple toast notification\n      const toast = document.createElement('div');\n      toast.className = `toast-notification toast-${type}`;\n      toast.innerHTML = `\n        <div class=\"toast-header\">\n          <strong>${title}</strong>\n          <button type=\"button\" class=\"toast-close\" onclick=\"this.parentElement.parentElement.remove()\">√ó</button>\n        </div>\n        <div class=\"toast-body\">${message}</div>\n      `;\n\n      // Add toast styles if not already added\n      if (!document.getElementById('toast-styles')) {\n        const styles = document.createElement('style');\n        styles.id = 'toast-styles';\n        styles.textContent = `\n          .toast-notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            min-width: 300px;\n            background: white;\n            border-radius: 8px;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            z-index: 9999;\n            animation: slideIn 0.3s ease;\n          }\n          .toast-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 12px 16px 8px;\n            border-bottom: 1px solid #e9ecef;\n          }\n          .toast-body {\n            padding: 8px 16px 12px;\n            color: #6c757d;\n          }\n          .toast-close {\n            background: none;\n            border: none;\n            font-size: 18px;\n            cursor: pointer;\n            color: #6c757d;\n          }\n          .toast-success { border-left: 4px solid #28a745; }\n          .toast-error { border-left: 4px solid #dc3545; }\n          .toast-info { border-left: 4px solid #17a2b8; }\n          .toast-warning { border-left: 4px solid #ffc107; }\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        `;\n        document.head.appendChild(styles);\n      }\n\n      // Add toast to page\n      document.body.appendChild(toast);\n\n      // Auto-remove after 5 seconds\n      setTimeout(() => {\n        if (toast.parentElement) {\n          toast.style.animation = 'slideIn 0.3s ease reverse';\n          setTimeout(() => toast.remove(), 300);\n        }\n      }, 5000);\n    },\n    // Verification file upload handlers\n    handleBeneficiaryVerificationFile(file) {\n      console.log('Beneficiary verification file selected:', file.name);\n      this.uploadedFiles.beneficiary_verification = file;\n    },\n    onBeneficiaryVerificationUpload(uploadResult) {\n      console.log('Beneficiary verification uploaded successfully:', uploadResult);\n      this.showToast('Success', 'Family member verification image uploaded successfully', 'success');\n    },\n    onBeneficiaryVerificationError(error) {\n      console.error('Beneficiary verification upload error:', error);\n      this.showToast('Error', 'Failed to upload verification image: ' + (error.response?.data?.message || error.message), 'error');\n    },\n    onBeneficiaryVerificationRemoved() {\n      console.log('Beneficiary verification file removed');\n      this.uploadedFiles.beneficiary_verification = null;\n    },\n    // Pickup person file upload handlers\n    handlePickupIdFile(file) {\n      console.log('Pickup ID file selected:', file.name);\n      this.uploadedFiles.pickup_id_image = file;\n    },\n    onPickupIdUpload(uploadResult) {\n      console.log('Pickup ID uploaded successfully:', uploadResult);\n      this.showToast('Success', 'Pickup person ID image uploaded successfully', 'success');\n    },\n    onPickupIdError(error) {\n      console.error('Pickup ID upload error:', error);\n      this.showToast('Error', 'Failed to upload ID image: ' + (error.response?.data?.message || error.message), 'error');\n    },\n    onPickupIdRemoved() {\n      console.log('Pickup ID file removed');\n      this.uploadedFiles.pickup_id_image = null;\n    },\n    handlePickupAuthFile(file) {\n      console.log('Pickup authorization file selected:', file.name);\n      this.uploadedFiles.pickup_authorization = file;\n    },\n    onPickupAuthUpload(uploadResult) {\n      console.log('Pickup authorization uploaded successfully:', uploadResult);\n      this.showToast('Success', 'Authorization document uploaded successfully', 'success');\n    },\n    onPickupAuthError(error) {\n      console.error('Pickup authorization upload error:', error);\n      this.showToast('Error', 'Failed to upload authorization document: ' + (error.response?.data?.message || error.message), 'error');\n    },\n    onPickupAuthRemoved() {\n      console.log('Pickup authorization file removed');\n      this.uploadedFiles.pickup_authorization = null;\n    },\n    // Address dropdown methods\n    async loadAddressData() {\n      try {\n        this.regions = await addressService.getRegions();\n      } catch (error) {\n        console.error('Error loading address data:', error);\n        this.$toast?.error('Failed to load address data');\n      }\n    },\n    async onRegionChange() {\n      try {\n        this.filteredProvinces = [];\n        this.filteredCities = [];\n        this.filteredBarangays = [];\n\n        // Reset dependent fields\n        this.formData.beneficiary.province_code = '';\n        this.formData.beneficiary.city_code = '';\n        this.formData.beneficiary.barangay_code = '';\n        this.formData.beneficiary.province = '';\n        this.formData.beneficiary.city_municipality = '';\n        this.formData.beneficiary.barangay = '';\n        this.formData.beneficiary.region = '';\n        if (this.formData.beneficiary.region_code) {\n          this.filteredProvinces = await addressService.getProvincesByRegion(this.formData.beneficiary.region_code);\n\n          // Set region name\n          const selectedRegion = this.regions.find(r => r.region_code === this.formData.beneficiary.region_code);\n          if (selectedRegion) {\n            this.formData.beneficiary.region = selectedRegion.region_name;\n          }\n        }\n      } catch (error) {\n        console.error('Error loading provinces:', error);\n        this.$toast?.error('Failed to load provinces');\n      }\n    },\n    async onProvinceChange() {\n      try {\n        this.filteredCities = [];\n        this.filteredBarangays = [];\n\n        // Reset dependent fields\n        this.formData.beneficiary.city_code = '';\n        this.formData.beneficiary.barangay_code = '';\n        this.formData.beneficiary.city_municipality = '';\n        this.formData.beneficiary.barangay = '';\n        if (this.formData.beneficiary.province_code) {\n          this.filteredCities = await addressService.getCitiesByProvince(this.formData.beneficiary.province_code);\n\n          // Set province name\n          const selectedProvince = this.filteredProvinces.find(p => p.province_code === this.formData.beneficiary.province_code);\n          if (selectedProvince) {\n            this.formData.beneficiary.province = selectedProvince.province_name;\n          }\n        }\n      } catch (error) {\n        console.error('Error loading cities:', error);\n        this.$toast?.error('Failed to load cities');\n      }\n    },\n    async onCityChange() {\n      try {\n        this.filteredBarangays = [];\n\n        // Reset dependent fields\n        this.formData.beneficiary.barangay_code = '';\n        this.formData.beneficiary.barangay = '';\n        if (this.formData.beneficiary.city_code) {\n          this.filteredBarangays = await addressService.getBarangaysByCity(this.formData.beneficiary.city_code);\n\n          // Set city name\n          const selectedCity = this.filteredCities.find(c => c.city_code === this.formData.beneficiary.city_code);\n          if (selectedCity) {\n            this.formData.beneficiary.city_municipality = selectedCity.city_name;\n          }\n        }\n      } catch (error) {\n        console.error('Error loading barangays:', error);\n        this.$toast?.error('Failed to load barangays');\n      }\n    },\n    onBarangayChange() {\n      // Set barangay name\n      if (this.formData.beneficiary.barangay_code) {\n        const selectedBarangay = this.filteredBarangays.find(b => b.brgy_code === this.formData.beneficiary.barangay_code);\n        if (selectedBarangay) {\n          this.formData.beneficiary.barangay = selectedBarangay.brgy_name;\n        }\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}